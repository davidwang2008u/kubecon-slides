Flux Deep Dive: A GitOps Approach to Progressive Delivery: QGUP-5006 - events@cncf.io - Tuesday, August 18, 2020 8:29 AM - 69 minutes

Participant: wordly [W] English (US)

Transcription for wordly [W]

00:00:20 [W] Hello folks, welcome to the flux get deep dive session. I'm sure the fun and together with my colleague today will be sharing some exciting news about the future of flux flux will
00:00:37 [W] Your transformation and we need your help in shaping the roadmap of both flux and Helm operator the kind Helm operator.
00:00:50 [W] Here are the top three most requested features from flux V1 users.
00:00:58 [W] Just to give you a background. We started flux at weaveworks four years ago. And since then kubernative ecosystem has evolved a lot flux was made to reconcile the cluster state to give using the single.
00:01:14 [W] It's very poised. Very single git repository as the source of Truth for both infrastructure and workloads alive.
00:01:23 [W] We've seen that flux users want a more flexible approach where the cluster State can be composed from different sources taking poor count multi-tenancy another important topic.
00:01:39 [W] The state can be composed from different sources take into account multi-tenancy. Another important topic is operationally inside when multiple teams share the
00:01:44 [W] Is operationally inside when multiple teams share the same infrastructure the same cluster flux should be able to issue events and alerts to each of those things when the cluster State changes.
00:01:55 [W] So we have ways of achieving all these features by let's say running multiple flux instances using Prometheus for monitoring using third-party tools as flux Cloud for
00:02:11 [W] And so on.
00:02:13 [W] To move forward we decided to take a different approach. We are breaking down flux into specialized components and we are rebuilding it with modern tooling to accommodate all these features and
00:02:29 [W] So this is how flux version 2 will look like manifest acquisition from get and Helm sources as well as the cluster reconciliation will be handled by different controllers.
00:02:50 [W] you as a flux user will be able to configure flux versus going to it using kubernative custom resources to Define sources set proper boundaries for tenants
00:03:06 [W] Those talents could share the same cluster or even share a fleet of coasters.
00:03:13 [W] So in order to build the next version of flux and Helm operator, we've been working on a project called the gitops toolkit.
00:03:34 [W] The toolkit is a collection of apis and specialized tools that interact with each other using kubernative events.
00:03:37 [W] These tools are developed with kubernative control runtime libraries and Cube Builder.
00:03:50 [W] So we standardized around to builder for developing all these components.
00:03:52 [W] The idea behind the toolkit is that you'll be able to build a continuous delivery platform that is tailor-made for your organization, and it could fit very well with your organization delivery news.
00:04:08 [W] The gitops tool kit comes with a companion CLI called PK in short from frontal kid with the cave can personalize the installation and configuration of your platform.
00:04:26 [W] You can on board git repositories or create new repositories configure altinity fication for them.
00:04:35 [W] All being reconciled on the cluster and you can also set the execution order of this type of reconsideration.
00:04:48 [W] You can set service accounts and pin and create dedicated kubernative Starbuck for your tenants and much more we
00:04:59 [W] So that clusters are mean don't have to write tons of llamo.
00:05:08 [W] If you want to interact with the turkeys controllers.
00:05:10 [W] via the communities API, you can use TK commands or of course, right yamas and apply them on the cluster via git repository. Both ways should work the same.
00:05:22 [W] So using TK, we can assemble flux can Helm operator V 2 from the turkeys component more importantly we can extend flux capabilities with extensions such as let's say you want to
00:05:42 [W] using TK we can assemble flux and Helm operator V 2 from the top is component more importantly we can extend flux capabilities with extensions such as let's say you want to
00:05:44 [W] Conciliation through GitHub webhook receivers or you want to send kubernative ents and toolkit other words flag for Microsoft tools all this will be possible by a doing
00:05:58 [W] It starts slack or Microsoft tools all this will be possible by adding more components to your client installation.
00:06:02 [W] So I think I jumped.
00:06:16 [W] So with the one of the core components of the toolkit, are these specialized reconcile hours?
00:06:33 [W] We have developed a customized controller and Helm controller.
00:06:41 [W] We are working on creating an image update controller what that means is the fact that you will be able to drive automation for your containerd images in the same way you do
00:06:53 [W] They but instead of annotating resources inside your git repository. You'll be creating update policies using the critical resources to drive this kind of Automation
00:07:09 [W] He is using the Cricut hack-a-thon resources to drive this kind of Automation and in the future.
00:07:12 [W] We also plan to create the fleet controller. The field controller will be interacting with kubernative cluster APA various Implement implementation to drive gitops
00:07:25 [W] Acting with kubernative cluster APA various Implement implementation to drive gitops work flows across your whole Fleet not just single cluster what's important here that all these specialized?
00:07:32 [W] all Fleet not just single cluster what's important here that all these specialized people centers will be getting their manifest their stores from The Source EPI and
00:07:42 [W] At the core of our toolkit is the is a feature called Source management.
00:07:57 [W] So we extracted get and Helm repository operations from flux and Helm operator and made the dedicated componentconfig Source control the source conqueror fetches kubernative manifests from different
00:08:08 [W] Let's say git repository or Henry post or multiple those and expose the manifests inside. The cluster is immutable artifacts. It also deals with authentification and it reacts the events from
00:08:24 [W] GitHub webhook or something like that.
00:08:29 [W] Here is a overview of how a diagram of how course controlling works. The idea behind the The Source control.
00:08:48 [W] API apis is the fact that cluster and we scan register trusted sources using kubernative custom resources that are subject to role-based access on the right side.
00:09:00 [W] You can see an example how you can on board the git repository and configure SSH authentication and pgp, very
00:09:04 [W] Patient for that particular source source control comes with the future that was missing from flux version one the ability to track get bags get tags based on
00:09:19 [W] Rings and this can prove very useful for production environments when you want to pin the cluster State plus specific tag or a specific GitHub release.
00:09:32 [W] And now I'm going to ask he that they cover and give you an overview of the toolkit components and talk about their unique capabilities today.
00:09:46 [W] Thank you. Stefan due to the limited amount of time we have today you will see me skipping some slides that are comparison slides between 41 and to cool tool kit components ribbon flux to see two features, basically
00:10:02 [W] Flights are published this go and have a look at them because you will get a better picture of the new possibilities of features a tool kit components introduced compared to flux V1.
00:10:14 [W] Because my eyes controller is a dedicated controller for applying resources on the cluster.
00:10:25 [W] It introduces a new customization custom research which contains a reference to a source control of kids repository and like the name suggests. It supports both customized overlays and then llamo manifest the letter is
00:10:36 [W] Zeus has a new customization system resource which contains a reference to a source control? Okay to posit very unlike the name suggests.
00:10:39 [W] It supported both customized overlays and then llamo manifest. The letter is made possible by generating customization the GMO on the fly during reconsideration of the customized saging Resource
00:10:46 [W] By generating customization Bill GMO on the fly through reconciliation of the customized sage and Resource One of the prominent new features compared to flex P. 1 is the fact that you're able to push that isolation.
00:10:52 [W] You can do this by assigning a service account to customization research and controller will perform the reconciliation energy seccomp, which means that for example apply actions to the cluster run
00:11:06 [W] just return assigned to this account which
00:11:11 [W] protects you you from
00:11:14 [W] resources getting applied in places where you don't want them to be applied.
00:11:20 [W] On this light you see an example through customization research.
00:11:33 [W] It's using a giftable squares the source and configure to be reconciled every five minutes when the controller search reconciling object. It will first fetch the artifact produced by The Source controller.
00:11:43 [W] It will then build the Manifest you to customize and surface.
00:11:46 [W] I fella date them against the kubernative API this guarantees that no partial by whatever happened.
00:11:50 [W] If the Federation succeeds, it will apply the Manifest and wait for the configured health checks through succeed before marking the customization already.
00:11:58 [W] These Readiness status can be used to cubicle away from the customization, but it's also used in depends on relationships defined in a folder customization resources, which make the controller rate for all the depends on definitions to be ready
00:12:14 [W] Can control that by order of customizations and one of the reasons you may need this is because you're making use of a custom research, but could some research definition is reconciled by another customization for president another git Repository.
00:12:27 [W] Thank you strictly to hell how many artists have been first.
00:12:38 [W] I said since the flux since we introduced the Helm of operator as a way to declaratively perform Helm actions using custom resource due to changes introduced in the toolkit down operator was no longer perfect fit to be included.
00:12:49 [W] Will's Helm and get the posters on Interpol by itself.
00:12:56 [W] This can now be offloaded for the source controller using Helm repulsed renowned artists from resources.
00:13:00 [W] The helm control as a complete rewrite of time operator using kubeflow der with various improvements.
00:13:12 [W] We approve the amputees API to meet long requested features and hopefully deliver better usually declarative user experience.
00:13:16 [W] I'm actions like install and upgrade her now if their own extensive preparation Flex in the custom research and different remediation strategies can be configured for wrap things go wrong.
00:13:28 [W] It also supports depends on relationships. Like the customers controller is the no longer perform dry runs for hamsters with protections as an overall simplified operation model as a result.
00:13:41 [W] It should really use less resources be able to
00:13:45 [W] Reliability work with any Helm chart no matter how they are structured.
00:13:48 [W] If you a bit of an ID what you see here is a fee to homeless resource the chart key in the research to find the template for the helm chart because to research it should be created by the hand controller down controller will create is in the same language
00:14:05 [W] reference the reason this template in lines and it defines referred to as a separate resource is to ensure that any scenario with Senate occupying the cluster only charge from precious Helm upholstery services that have been created by Christa administrators can be installed
00:14:22 [W] Thing is the fact that the church version see support some for ranges is makes it possible to advocacy group for my Peds or new chart releases and other configuration shown can only be already been configured in defeat. One of them is research, but they have
00:14:38 [W] The other configuration showing can only be already be configured in the few one of them and these research but they have been redesigned to offer a simpler and more descriptive API.
00:14:41 [W] As much as but Stefan briefly before due to the fact that we now have Crystal resources. We emit kubernative s for all the custom resources, which are included in the toolkit. The
00:15:00 [W] Bernard system resources, we emit kubernative s for all the custom resources which are included in the toolkit. The notification controller makes it possible to forward these
00:15:04 [W] our makes it possible to forward these offense to external system flux flat disk or Microsoft teams, but also to a generic broken quite by creating provider and alert system resources, and it's also able to handle events coming
00:15:16 [W] All systems like get a gitlab it back at Harbor or even a Jiang can see I've lined by creating new server receiver custom resources. The notification could deliver bread and HTTP endpoint for every receiver
00:15:32 [W] Figure reconciliation of the configured resources whenever book is called.
00:15:37 [W] When you have everything wired up your cluster, it looks a bit like this.
00:15:45 [W] The research on the right right to find to get up receiver with legs to push it and from GitHub when a navigation controller receives an event from get a little fella data payload essence of configure token in the secret lab and it will trigger a Reconciliation of the appropriate resources.
00:16:01 [W] During the reconciliation of group of components for the kubernative to relationship and student education controller notification for the derive these events to the external system based on filter slightly sensibility and a both objects.
00:16:17 [W] Except for when I talked a bit about progressively delivery and how flatter fit into this.
00:16:25 [W] Thanks.
00:16:29 [W] Well, so some of you may be familiar with the flagger.
00:16:40 [W] It's a project that we've been working on in the past two years almost you can think of Flagger in the gitops toolkit context as a specialized controller that helps you reduce the risk
00:16:52 [W] Releases and Flagler can enable you to use Advanced deployment strategies when you are releasing applications with the
00:17:09 [W] first strategy that we can Implement a flagger is called Kennedy release and this relies on the fact that Flagger can control the traffic between two versions
00:17:26 [W] Do a progressive traffic shifting from the current version to the new version that was promoted and this works great for applications that are exposing
00:17:43 [W] He apis another strategy that you could use is called a be testing how ND pasting works. You will be segmenting your users and based on HTTP headers
00:17:58 [W] The cookie you can configure a flagger to Route only those specific users the new version and flatter will observe how the the users are interacting with the new version if there are
00:18:14 [W] I will observe how the the users are interacting with the new version if there are errors if there are things like increased latency and based on those metrics, it will promote or roll back
00:18:23 [W] It will promote or roll back the new version.
00:18:34 [W] another strategy is blue green with traffic mirroring. This kind of strategy works. If you have one Ingress controller or servicemeshcon keister that knows how to do traffic mirroring and it it's
00:18:39 [W] it for idempotent apis something like a machine learning work for workloads or something that does reporting any kind of API that does only read
00:18:55 [W] Fit with with this type of strategy the idea here is that all the traffic that your users are generating on the old release that traffic is
00:19:11 [W] Flag of looks at the metrics tag besides if you should promote it on lat and finally is the classic blue green strategy where Flagger will spin up the new version
00:19:27 [W] I'm your end-to-end tests confirm on tests can also do load testing for for for the reversion and based on those results. We took from Motorola.
00:19:40 [W] So Flagger works out of the box with the ghettos three-peat we can use it even today.
00:19:58 [W] What we are trying to do in the future in is making the toolkit aware of the Cannery analysis that flatter performs.
00:20:04 [W] And in this way, we can Leverage The depends on relationship that took it introduces with Flagger Kennedy so you can imagine you can say I
00:20:11 [W] want to run first the release for The backend API then do the release for the front and the back so you can decide strict
00:20:26 [W] depends on relationship that toolkit introduces with Flagger Kennedy so you can imagine you can say I want to run first the release for The backend API then
00:20:28 [W] the rollout of your whole infrastructure based IDs that depends on relationships
00:20:33 [W] and this was about Progressive delivery.
00:20:38 [W] We are kindly asking you if you are interested in participating in in the toolkit design and the toolkit and becoming
00:20:56 [W] Being more useful. We have enabled GitHub discussions on our flux CD toolkit repository.
00:21:08 [W] We invite you there to create a new discussion and you know come up with proposals.
00:21:21 [W] If you have any or comment on the current proposal, we have a thinking place where when we want to add the new API or we went or when we want to, you know, create the neuvector.
00:21:27 [W] The future inside the toolkit will be creating a discussion everyone. You should debate on what's the right decision to implement that feature. And once that is is finalized only after then we create an issue on the
00:21:42 [W] And we think that condition so we asked everyone that's wants to be involved in this process reach out to us.
00:21:54 [W] We are also available on the cncf slack and on the flux and flux - death channels and this was it.
00:22:02 [W] it. Thank you very much.
00:22:03 [W] Hello, I'm going to answer some questions from the chat.
00:22:38 [W] So one question is is there a way to use flux and not be a cluster. Admin name space access slash admin only and use flux, so, please
00:22:50 [W] What's the to we we have a way of restricting what a git repository can alter on the cluster so flawlessly to made out of Turkey
00:23:07 [W] On is cluster.
00:23:09 [W] admin on each cluster on your Fleet, but then you can say for this particular give me points story all the things that users will be placing it at E3 will be
00:23:25 [W] the first rounder so
00:23:32 [W] display and in fact relate in a way or your teens under specific service account and linbit those actions
00:23:50 [W] Question how far is the toolkit from being production rate? We have a roadmap on the toolkit website and we we have progress bars for each
00:24:06 [W] We have progress bars for each milestone.
00:24:08 [W] One Milestone is the first one is getting feature. Parity with rocks read-only mode what flux read-only mode means is when you run flux only to apply changes in get without allowing flux to right back to get
00:24:24 [W] Means is when you run flux only to apply changes in get without allowing flux to right back to get things like image objects. For example, so flux in read-only mode parities is at
00:24:31 [W] So flux in read-only mode parities is at 80 percent right now.
00:24:39 [W] We we want we are left with implementing soap soaps decryption and writing guide on how to can upgrade from V1 to V2
00:24:48 [W] are currently experimenting with the image update controllers and we welcome anyone that you have ideas on how we can make the
00:25:04 [W] It work for you, please join our discussion on on GitHub as for the helm operator. We are let's say around 50 percent. We still want
00:25:20 [W] Work on automated rollbacks based on specific events such as evil hand test fails then maybe you want to do not own a rollback or if the
00:25:36 [W] And all these rollback conditions are are being developed right now.
00:25:44 [W] He then you can take another question.
00:25:53 [W] There's a question about how Down release.
00:25:55 [W] here's our synchronized to the cluster.
00:25:59 [W] It's basically very simple the customers controller sings them and you can put any resource in to get repository and the customized controllable how to generate the customization the GM or Ford. So the loop is basically that
00:26:12 [W] Too much control that applies them to the cluster and then the helm control over to pick up the apply of the resource.
00:26:20 [W] And that's how it's synchronized from get any other questions.
00:26:32 [W] There's a question about the graphic user interface.
00:26:39 [W] have a very Advanced Prometheus that dashboard that admittedly ships for every controller and we're looking at other options to give
00:26:43 [W] if you a better overview of custom resources, which are part of the toolkit, but there are no specific plans at the moment.
00:26:53 [W] Yeah, I can I can second that and say the coredns maintainers of the flux ci/cd organization are mostly beckoned people so I don't feel
00:27:10 [W] Inga UI for flux and I don't know if if someone wants to contribute that and has no front end skills knows challenge script very well.
00:27:26 [W] We are happy to collaborate on that. But the current King will not be working on a on the user interface get for us is the user interface.
00:27:34 [W] Another question.
00:27:46 [W] Will there be an arm release for the gitops toolkit?
00:27:49 [W] We have experimented experimenting with Docker buildpacks inside GitHub actions to build the multi Arch image for kubernative controllers
00:28:02 [W] It works it takes around half an hour.
00:28:06 [W] To build we have in the toolkit. The Indian would be around seven controllers. So can imagine waiting 30 minutes after each bill after each comic doesn't doesn't scale.
00:28:22 [W] We cannot work with this kind of deal pipeline. So we are
00:28:30 [W] we'll be collaborating with with GitHub and find the solution so we could maybe build our man armed 64 images on dedicated machines and publish those images separately
00:28:46 [W] labyrinth in with GitHub and find the solution so we could maybe build our arm and arm 64 images on dedicated machines and publish those images separately or
00:28:47 [W] In other way, what will happen when took it is more stable have a arm release at some point.
00:28:57 [W] Another question was what is the migration path from flux? You want flux V2, so
00:29:17 [W] If you are using let's say flux in read-only mode right now, you could uninstall flux run TK install ad the get the same giriboy story. That flux was
00:29:33 [W] And the toolkit will take it from there with no downtime to your workloads or anything like that.
00:29:46 [W] If you are using flux dot llamo and you do a customized build inside with flux, the same thing will work with no changes, but if you are,
00:29:55 [W] custom shell scripts, or I don't know you run your make files and you do set to replace things in your yama's that will there is no migration path to that basically will not going to support
00:30:11 [W] Custom scripts.
00:30:16 [W] Those are more for ci/cd.
00:30:21 [W] Our recommendation is if you are doing custom mutations templating or whatever you are doing with your yama's try to do it in CIA and publish the end result llamo
00:30:31 [W] Particular branch and then configure the tool kit to synchronize with that Branch. The only exception to this is customized overlays in
00:30:47 [W] If lies with the you can you can tell the reconciler where is the path to a specific customized overlay?
00:31:00 [W] And the toolkit will will build that for you but except customize and Helm we have no plans on supporting any other templating most templating
00:31:08 [W] Anyway, so I think it's a it's a better approach to do it in CIA and afterwards run things like Opa or linking and all these things in your CI pipeline. So the
00:31:24 [W] Has will end up in the cluster in a valid format.
00:31:30 [W] There is there is the question.
00:31:43 [W] What is the developer experience?
00:31:46 [W] Okay.
00:31:50 [W] Let me talk for a minute about developer experience flux V 2 runs.
00:32:01 [W] Let's say a synchronous from your get operation so I could do a git push then at some point flux will synchronize that.
00:32:08 [W] On the cluster and if you want to find out if the failed or not you have to look at flux logs, or you can configure slack notifications for example have to look there with the gitops toolkit and in flux
00:32:23 [W] And to have more ways to notify the author of that commits that something is wrong or if whatever the change was that was
00:32:39 [W] So how we do that?
00:32:45 [W] We have a we have a pull request open to add git Hub status commit right back.
00:32:54 [W] What that means is you don't commit.
00:32:55 [W] Let's say to the staging Branch the toolkit will apply those those changes. They need to write back to GitHub on that particular commit was the final status.
00:33:08 [W] Did it worked. Did it fail it also?
00:33:10 [W] Each has a health check results.
00:33:24 [W] So for example, maybe the apply worked but then your deployment has failed to rolled out and we'll let you know in the in the status object inside GitHub that that particular deployment
00:33:28 [W] And we are also publishing the error messages to slack Microsoft gains and you can build your own notification pipeline from there.
00:33:44 [W] We also issue kubernative events.
00:33:48 [W] So there is more insight into what's happening in the cluster with your changes.
00:33:53 [W] In flux, E2 and of course dashboards and metrics.
00:34:05 [W] I think we are getting close to the end.
00:34:18 [W] Thank you very much for your questions. And please take a look at toolkit. The flux edita bio is the website where we have guides tutorials
00:34:21 [W] If occations and if you have questions for us, please start the discussion on GitHub or reach to us on on slack.
00:34:33 [W] I don't work please for any advanced questions go to the threaten the cncf slack Channel and we can give more funds onto answers because I just
00:34:48 [W] Sense, and I simply can't do it in this time frame.
00:34:52 [W] Thank you. Thank you very much folks.
