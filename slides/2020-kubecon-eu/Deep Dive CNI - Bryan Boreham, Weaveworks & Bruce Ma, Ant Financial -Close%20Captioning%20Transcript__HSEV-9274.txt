Deep Dive: CNI: HSEV-9274 - events@cncf.io - Wednesday, August 19, 2020 7:00 AM - 50 minutes

Participant: wordly [W] English (US)

Transcription for wordly [W]

00:00:00 [W] Hello and welcome to the cni-genie Deep. Dive talk. We got a couple of the cni-genie team ain't a nurse here before we get started.
00:00:21 [W] It I just want to put up some information.
00:00:26 [W] This is this is the slide that usually appears at the end and I will put it up again at the end. But if you are totally new to see an IR Ely recommend you start with the intro session which which if you're watching this live stream yesterday,
00:00:39 [W] It but there's a link there if you want to look at the software the spec anything like that.
00:00:46 [W] It's in the those GitHub repos and we do have our own slack. Although II hope if you're alive.
00:00:58 [W] I hope you run the cube con chat, and we do have we're here Bruce and I should be live at that time. So please get asking your questions if you have some.
00:01:07 [W] This talk, we're going to go through very brief.
00:01:13 [W] What is cni-genie?
00:01:36 [W] Let's get going.
00:01:38 [W] Bruce yes.
00:01:44 [W] Hi everyone.
00:01:46 [W] This is peruse suffered.
00:01:50 [W] I'm software engineer at Sanford a show from China.
00:01:57 [W] My major work is you know some containerd networking including the you know, building some Network plug-ins for our communities clusters to Ingress controller and the best operator
00:02:06 [W] Or some celebrities for the scene at him.
00:02:10 [W] I'm a freshman.
00:02:12 [W] I joined the team since September last year make it had ID is Mars 1024.
00:02:23 [W] So if you have any question just ping me on line.
00:02:24 [W] Hey, Brian.
00:02:26 [W] Thanks Bruce.
00:02:33 [W] So, my name is Brian boru. I work for weaveworks, which is probably best known as the gitops company right now, but we were very early into the Container networking seen with we've met I've been lead maintainer and
00:02:44 [W] That for about five years now.
00:02:49 [W] I'm also a maintainer on the cni-genie.
00:03:05 [W] Okay, let's open up its going to give you the the very high level view of what is cni-genie.
00:03:35 [W] um, so the cni-genie
00:04:05 [W] And it's equally wants to be even-handed about which network you using so cni-genie finds a specification.
00:04:14 [W] it's the most important part how you talk and make a request and then it we also have some Library code to help you implement that and some some base plugins that are used by many people
00:04:28 [W] But it's important to say that that a lot of the cni-genie of sits in the middle and a lot of questions people have are really about the upper layer, but who's calling cni-genie?
00:04:55 [W] Okay, I'm going to hand over to Bruce now and Bruce is going to tell us about the whole subject of cni-genie instability.
00:05:04 [W] yes first let's take overview to the ci/cd spirity as we know the singer has defined the specification between the containerd runtime and the plugins
00:05:21 [W] But just not enough because sometimes we want to pass some, you know, dynamic or custom information to our plug-ins for some case.
00:05:35 [W] For example, if we want to assign some IP address for container if want to set boundaries host Port mapping Mac or M24 containerd interfaces,
00:05:47 [W] Says this is this cannot be done by spec. So to handle these user cases. We need to override the impulse to our plugins.
00:06:01 [W] This is called see I accessibility, you know, be honest back and we have be sinking this question from the beginning of seen. I and actually they say I have Evolution way from
00:06:13 [W] They say arguments two arguments in config to capabilities in my opinion.
00:06:25 [W] I think this way is from easy to Weiss from free to customize.
00:06:30 [W] So let's come to the first answer of let's come to the first answer of CN IX specialty to singer arguments.
00:06:45 [W] The senior government is born with original sin as back. You know, it's appeared long time ago and just as its name, it was passed by the environment variables, you know
00:06:56 [W] When we calling the packing and there is format is some keyword appears separated by semicolons in a single screen and you know cri-o commands is you know,
00:07:11 [W] Is how easy way as user to be implemented and easy to be used to visit you got to be debug and because we can covers.
00:07:22 [W] One can carry several key value pairs in screen in one time.
00:07:31 [W] It's flexible, but
00:07:35 [W] say arguments have the worst limitation it because the string is flat it cannot it's not easy for it to hold structure data so such like Jason so
00:07:50 [W] Commence has been deprecated and the takes the lowest priority.
00:08:03 [W] here's the question if we do not use un's to pass or arguments.
00:08:04 [W] What should we use instead?
00:08:10 [W] So we discussed when we come to the second answer of saying I accessibility the arguments in Conflict Jason, you know, please take look at the right picture.
00:08:22 [W] We can see the arguments is special feel the in the network configuration.
00:08:33 [W] So this is because we think the Jason Network config is a better place to hold all the dynamic information and
00:08:35 [W] This way it's easier to hold a structured data because it's just in a structure teacher Jason and the history documenting.
00:08:49 [W] config.
00:08:54 [W] Jason has introduced inspect open 2.0 and there is implemented in code release all point 4.0.
00:09:03 [W] But this way still have some limitations the first limitation is you
00:09:07 [W] You are a way get the network configuration from disk.
00:09:14 [W] Still value, but if we want to feel the genomic information into it, we have to read it Percy time to fill it, you know override it.
00:09:29 [W] So the override function has to be implemented by ourselves, you know by the user the second limitation is, you know, just at format, you know, we carried all the
00:09:41 [W] Genomic information in a single map. So this map will be possible to every Plucky whatever the inverter is needed or not.
00:09:55 [W] So, I don't think this is a good bike the CX s ability is designed for carrying extra information, you know to Ability Beyond the spec but
00:10:07 [W] To date be fully customized.
00:10:16 [W] I don't think so because this will cause some control lost we want to pass specific argument to specific plugins.
00:10:25 [W] you know, this is what we want and with this questions. We come to the latest answer the capabilities is which has another name to runtime configuration.
00:10:37 [W] And capabilities take two main advantages over the previous ones to us. And the First Advantage is you know, plug-in can Define these additional fails in network
00:10:52 [W] Fake, you know, this can be used as provide addition and secondly the week a uses additional field to elotl filters a information puss.
00:11:08 [W] Specific information tools specifically plugins this will help to remove the dated information and the second Advantage is Advantage is the lead singer has Implement
00:11:24 [W] Override function for us.
00:11:28 [W] We don't have to implement it configure override function ourselves and the picture below. So to how the capability works, you know here is
00:11:43 [W] a plugin named support mapper and it declare the convocation that it's need probability named the poor mappings then leave Syria will
00:11:56 [W] Gather the dynamic information from map streams and into a map.
00:12:05 [W] Then the radius. Yeah, we all search the map with with the key formattings a found. It will generate a new Json which is filled by the
00:12:17 [W] Its value.
00:12:19 [W] Yes, you can see the runtime config field is a new field field by field by the Gypsy.
00:12:34 [W] I then the lips our pastor knew Jason to the plug-in, you know with X4 information, so
00:12:41 [W] let me know the second I expect he has, you know, a long journey to their capabilities, but is capability to final answer for the dynamic configuration
00:12:56 [W] For now in my opinion.
00:12:59 [W] I don't think so because capabilities still have some limitations. The first limitation is if we want to introduce a new capability. It needs some cost
00:13:13 [W] First we need to change the canet work config.
00:13:22 [W] Secondly. We need to do some code changing containerd runtime.
00:13:29 [W] This is you know Coast the second limitation is now the capabilities as only come from containerd right time, which means that the actual information can only be passed from
00:13:38 [W] All of straight into plugins, but in some case, we think that you know, the actual information can be generated by the Prius Plug-In, which is expected to
00:13:52 [W] Be passed to the next plug-in in this case cavity won't helpers.
00:14:00 [W] So I see I think ability still needs some improvements in the future first. I think ability need self-discovery and secondly the
00:14:16 [W] Soon Cabriolet should be passed over plugins, you know, not just from the Upstream that at last I think you know for the second time which would provide more utility package
00:14:31 [W] All these see I accessibility. So if someone want to introduce some, you know extra information to the Appliance, we want to make it easier.
00:14:43 [W] In the end of my parts, I will share you can be written summary and all the three candles tikv sensibilities know from different perspective.
00:15:01 [W] I think the community is most recommended way for the CIA accessibility.
00:15:13 [W] So if you want to extend this thing, right use communities.
00:15:15 [W] So next part Brown will give you two something about the recent series i Brand.
00:15:26 [W] Thanks, Bruce.
00:15:35 [W] There was really interesting and just thinking while while you were talking, you know, if anyone listening to this is interested in that idea of extensibility. Please do
00:15:44 [W] Message in the chat here or come over to our slack on the the cncf slack. The cni-genie tis is pretty small and basically volunteer run. So if you do want to engage
00:15:59 [W] With us your ideas for enhancements or whatever if you're willing to do some work, please please come on engage with us. If you just want to request it that we do work might take a bit longer.
00:16:14 [W] Okay, so I'm prepared some slides to talk about seavey's what do we what do we mean by CV?
00:16:21 [W] We mean some kind of security vulnerability and they're they're given numbers going to given unique identifier so that when we talk to someone we know we're talking about precisely the same
00:16:35 [W] Issue if we have that identifier, so I picked a couple first one.
00:16:48 [W] I'm going to talk about has the Glorious name of cve 20 2010 749 that name doesn't mean anything.
00:16:55 [W] Like I said, it's just a just a tag to a unique identifier, but it is about this router advisory message. And then I'm going to talk about a totally different issue after that.
00:17:06 [W] Let's look at the the first one.
00:17:13 [W] What is the scene?
00:17:16 [W] I've got. I've got one host here the blue box represents your ordinary code that you're running some containers in your system and the red box somehow an attacker is running code there.
00:17:29 [W] Now you might think you know, my my system is protected attackers can't get in and run code, but maybe they maybe they attacked the Upstream supply chain, you know, maybe maybe the Cornerstone of your
00:17:44 [W] The first to put the code in or maybe some library that you using some tool that goes into a container really difficult to to ensure that the whole supply chain is pure and perfect.
00:17:59 [W] So so maybe the attacker can get some malicious code sneak it in and the guys have something that you want to be roaming.
00:18:05 [W] Anyway, if that has happened and the attacker sends this message forges a fake router advisory message.
00:18:21 [W] And and what they say in this attack is they basically tell Linux to send all the IPv6 traffic here many many systems are running with the capability of ipv4 and IPv6,
00:18:30 [W] 6 but really only ipv4 configured they're really only expecting to use fee for so if the attacker sends this fact message saying hey send me all your IPv6 traffic.
00:18:45 [W] Well Linux will obey that instruction.
00:18:45 [W] So the next part of the attack is when you're innocent software tries to open a connection, you know, maybe this is making requests may be unique TTP request something like that.
00:19:01 [W] There's this cool thing the called happy eyeballs.
00:19:08 [W] It's kind of a weird name.
00:19:09 [W] You can look it up.
00:19:10 [W] I'm didn't invent it and the basic idea of happy eyeballs. Is that when you open a connection it's going to open or attempt to open ipv4 and IPv6 connection symbol taneous lie.
00:19:25 [W] And it's going to pick the fastest one to come back.
00:19:34 [W] And the reason for this the reason this exists this happy eyeballs. Algorithm is is we're kind of in a transition from ipv4 to IPv6 and we want to be even-handed we want to
00:19:44 [W] You know not not favor one or the other so literally those requests are sent out simultaneously is as far as possible.
00:19:53 [W] So in if you have this malicious code unfortunately running in your system.
00:20:08 [W] Then the V6 request is going to hit the the attacker because they're running right next to your real code.
00:20:16 [W] Their response is very likely to be the fastest one. So what we end up with is that your client is now talking to the attacker and running a fake.
00:20:24 [W] Service, they do have to run the entire TCP stack inside their code the Linux one kind of legitimately route packets to
00:20:38 [W] To a fake attacker in this way, but it's it is perfectly feasible to implement a TCP stack in user code.
00:20:50 [W] So so this attack can work.
00:20:55 [W] They can make fake responses.
00:20:56 [W] can mount a man-in-the-middle attack, you know take your take your real request and maybe change it slightly and pass it on send the money to their bank account instead of your bank account.
00:21:07 [W] This this vulnerability was reported to us and we had to take action.
00:21:15 [W] So what what did we do?
00:21:20 [W] I've drawn a few different mitigations on this slide. First one over on the far right is the code change that we made this was to change a
00:21:31 [W] Ting and to Linux saying do not accept router advisory messages except R equals 0 like like many of these things the actual code changes like two lines just set that setting it did have to be deployed
00:21:46 [W] Read in every different implementation of cni-genie.
00:22:12 [W] That's one mitigation that we put up the next one coming left.
00:22:20 [W] I would definitely recommend that you turn off what's called cat net Roar. This is a capability which is like a Linux permission to send raw packets.
00:22:33 [W] This is what allows an attacker to forge anything. They like router advisory messages the entire fake message the entire TCP stack.
00:22:41 [W] None of that is possible.
00:22:42 [W] You just don't allow people to forge packets.
00:22:51 [W] If you insist that they go through the operating system to open sockets and make requests.
00:22:51 [W] So so very much recommend that it is it is on by default.
00:23:00 [W] And so you have to turn it off but it's for me that's a recommendation. And the last one I'll mention if you had some kind of authentication on your connection that I've put TLS here could be something else.
00:23:13 [W] if that is the case, then the attacker has to work harder because not only do they have to get the fake code and send the fake messages, but they have to have your credentials to participate in an authenticated connection whether it's TLS or something else, so
00:23:28 [W] So definitely think about those kind of mitigations not only for this vulnerability, but for future vulnerabilities that you've not discovered yet.
00:23:39 [W] Having described that one.
00:23:45 [W] Let's look at another one.
00:23:49 [W] This one's about demons listening on 127.0.0.1.
00:23:54 [W] This is this is the local host address or the loopback address.
00:23:57 [W] So in this picture, we've got two hosts.
00:24:06 [W] One of them is listening on this address and and most people I would certainly have told you this before I knew about this vulnerability. Most people will believe that that address can only be accessed.
00:24:09 [W] From The Local Host.
00:24:13 [W] So they think it's safe.
00:24:14 [W] I just listened on that Local Host address and nobody can come in from another machine.
00:24:25 [W] If somebody does try to do that.
00:24:31 [W] Well, they can an attacker on another machine can say, you know, please will you route packets to that address if they have control of this machine machine be in the picture then the
00:24:39 [W] As packets will go out and if there are reasonably close if they're on a local network to the host. They're trying to attack.
00:24:49 [W] Dress here, 36 whatever if that's close to the packets will arrive but Linux will drop them.
00:25:00 [W] They called martians Martian packets. They appear from outer space. So that's the normal the expected State of Affairs.
00:25:13 [W] Most people will tell you that's what happens. You cannot route to that address surprise.
00:25:17 [W] There is in sin the ci/cd where there's a thing called Port map plug-in and the same thing happens in other bits of software Cube.
00:25:28 [W] Proxy is an example. It changes the setting it says I do want to Route the that local address and it does it for kind of intricate reasons to do with how traffic is redirected inside
00:25:43 [W] For the mapping of services.
00:25:51 [W] But anyway, the bottom line is if you have that setting if you have root localnet equals 1 that connection is possible attackers can now talk to those demons that believed they could only be accessed
00:26:00 [W] By somebody already on the host. So what to do about this.
00:26:09 [W] Well, the code change that we shipped in a cube proxy for instance and in we've now again put out a release with this change in it was was to add a rule iptables rule blocking those connections,
00:26:22 [W] So that makes that safe again, but once again that I if those connections were authenticated in TLS is an example could be something else then it makes it that much harder for the attacker.
00:26:37 [W] So there you go a quick walkthrough of two different very different vulnerabilities, but I hope it gives an insight into just how these things
00:26:51 [W] In to relate how the bunch of different layers can kind of Stack up and come up with a behavior.
00:26:57 [W] That's unexpected.
00:27:02 [W] And of course that's what attackers do they do the unexpected because because they're trying to hack your system. So that's the end of the prepared slides
00:27:13 [W] I'll put that information slide up. Once again. If you are into deep the intro session link is up there. The video should be up shortly after the original streaming
00:27:29 [W] Our software is in to Repose one for the spec and libraries one for the plug ins the base plugins that we support.
00:27:38 [W] We do have our own slack lovely to see you there. If you want to head over do not kubernative says its own slack. So so do note that difference cni-genie not part of kubernative.
00:27:50 [W] It's Works across many different container runtime. So if your question is really kubernative specific. Please head over to their their slack instead.
00:28:02 [W] Okay, we're done with the prepared section.
00:28:07 [W] I hope you all have questions and our have been typing them already.
00:28:14 [W] But if not, please start now and Bruce and I should be online to answer them tanky.
00:28:18 [W] All right, Brian here.
00:28:32 [W] I hope you can hear me.
00:28:33 [W] We had a we had a few technical issues, hence.
00:28:36 [W] I'm on video, but I am here live so we had a few questions already a number of them were kind of touched on by that last thing I said that cni-genie independent project
00:28:50 [W] Of kubernative and a lot of obviously kubernative being very large dominant project a lot of the questions that people have relates to kubernative, but we're not really in a position to speak
00:29:05 [W] For kubernative. He's they have their own Sig Network.
00:29:15 [W] And yeah, you really better off asking them question just came in from hirotaka.
00:29:21 [W] I hope I said that right are there any plans to add grpc interface to cni-genie?
00:29:35 [W] Intro session.
00:29:37 [W] I mean the answer is broadly.
00:29:38 [W] Yes.
00:29:40 [W] Yes, we've talked about this.
00:29:43 [W] So see, you know, it was was created originally the very first project use it was the was the rocket projectile Katie and Rook.
00:29:58 [W] It had no demon it.
00:30:03 [W] everything was team unless it just exact program. So that sort of followed through to the architecture of cni-genie. Just exact a program.
00:30:07 [W] And yeah, you're absolutely right.
00:30:12 [W] if you got a demon running then talking grpc to it is kind of more standard in to
00:30:13 [W] His world more expected.
00:30:20 [W] easier to do kind of global state things cni-genie
00:30:46 [W] find in the in the Repose actually me see if I can.
00:30:50 [W] Moved back to that slide that has the links on it.
00:30:56 [W] It's not work you hope that worked.
00:31:01 [W] Yeah, take a look around, you know, just search for grpc in the issues on the cni-genie.
00:31:26 [W] Touch to do the coding.
00:31:30 [W] we'd love that.
00:31:32 [W] Okay. Let me try any new questions.
00:31:38 [W] I don't see any new ones that have come in. So let me turn to a couple that I answered.
00:31:45 [W] Earlier on on the on the Q&A typing which we're about like extra attributes passing information kind of specifically from kubernative.
00:32:01 [W] But but as a more General Point, there's kind of a fine.
00:32:03 [W] Distinction between what's interesting to you and what's useful to everyone and we try and walk that line with the cni-genie.
00:32:33 [W] That's kind of anathema.
00:32:40 [W] The the whole point of cni-genie to allow everyone to play on a Level Playing Field, although all the container runtimes and all the networks can come together with this very simple core interface.
00:32:48 [W] That's the idea.
00:32:59 [W] So, you know, if you come across a situation where you said gcn is preventing me from doing this thing that I want to do then by all means get in touch reason issue talk to us because the
00:33:03 [W] The request and the response has our Jason fundamental you can add anything you like, you know, we don't we do not barf on unexpected Fields so you can add.
00:33:18 [W] You know Bruce and his butt was talking about specific ways that we've tried to style the way that people add Fields, but fundamentally, it's Jason you can say whatever you like,
00:33:33 [W] You couldn't you can put a megabyte in there saying you know, whatever you want to say in your Jason and the only requirement really is that you got at least one run time implementing it and at least one
00:33:49 [W] You plug in implementing that I would say if you find, you know, lots of plugins implementing it or lots of runtimes then that would be a time to come to the cni-genie and say you ought to standardize this
00:34:03 [W] We actually have two levels of standardization. We have we have the spec the formal spec that everyone has to conform to and then we have a document called conventions, which is exactly to get out of this compelling everyone to do something.
00:34:18 [W] So we can add things to the conventions document very easily but you know, you would need some evidence that it is actually a convention that there's a more than you using it in order for us to publish it to the world.
00:34:34 [W] Old so yeah, you know, we're definitely interested in playing our part but don't don't kind of confuse the cni-genie which goes across everything with one specific project even kubernative big as it is and we love kubernative.
00:34:47 [W] So that I'm going to wrap up. I'm on slack in the cncf slack you can ask their and or you can ask in the
00:35:03 [W] Issues, I hope to see you around.
00:35:07 [W] around. Thank you very much and goodbye for now.
