Proxyless Service Mesh with gRPC: NYKY-0312 - events@cncf.io - Thursday, November 19, 2020 5:42 PM - 29 minutes

Participant: wordly [W] English (US)

Transcription for wordly [W]

00:00:00 [W] Hi, this is Mohan.
00:00:01 [W] I'm a theocracy Montana in this talk.
00:00:04 [W] I will talk about the RPC and service mesh and the service match spot within your PC.
00:00:09 [W] So first of all, what is job you see I think many of you must have known this.
00:00:14 [W] If I'm work that's good to used for building microservices.
00:00:19 [W] But in practice for Microsoft cases, you will need more than just the opposite framework.
00:00:25 [W] For example before you can send up. He says you will need to find the new Services while sending our pizzas.
00:00:31 [W] you are care about load balancing and security before servicemeshcon is added into grpc grpc provides limited support for those problems.
00:00:40 [W] There is one DNS resolver.
00:00:42 [W] There are two very simple pick first and want to be imbalances here is give us results to support in grpc.
00:00:49 [W] But there's only configurable at the start up time for observability.
00:00:53 [W] There's no building that there's an open sensors plugin.
00:00:56 [W] Of course, you can write your own Pride ins to get those Advanced features that you will need but writing and maintaining blood enzymes can be a lot of work.
00:01:05 [W] because of those problems there's a need to integrate grpc with servicemeshcon.
00:01:11 [W] Let's take a look at all servicemeshcon of those problem.
00:01:15 [W] So servicemeshcon actual infrastructure layer added to the deployment to control how different parts of the system interact with each other.
00:01:24 [W] There will be one servicemeshcon troll plan that is this responsible for all the configurations the servicemeshcon of like servicemeshcon that departed without objection. We'll get the configuration from the control
00:01:39 [W] Configurable at the start up time for observability.
00:01:25 [W] There's no building that there's a open sensors plugin.
00:01:28 [W] Of course, you can write your own Pride ins to get those Advanced features that you will need but writing and maintaining platens can be a lot of work.
00:01:37 [W] So because of those problems there's a need to integrate grpc with servicemeshcon.
00:01:43 [W] Let's take a look at how servicemeshcon of those problem. So servicemeshcon actual infrastructure layer added to the deployment to control how different parts of the system interact with each other.
00:01:56 [W] There will be one servicemeshcon troll plan that is this responsible for all the configurations the servicemeshcon of like servicemeshcon that depart with selection will get the configuration from the control
00:03:21 [W] Decide what traffic should go and they also do all the other features like security and observability.
00:03:27 [W] So in this more concrete example, this is how typically servicemeshcon Floyd the application that grpc application will be deployed with a sidecar proxy the
00:03:42 [W] Configuration of found the control plan and there will be one connection between the grpc of the casing and the proxy. So all the traffic will be sent to the property. First. The proxy is then based on the configuration it got from the control plan decide
00:03:56 [W] Roxy is done based on the configuration it got from the control plan decide where the traffic should go.
00:03:59 [W] Once you can see in this model is that much of the surface casing ways in the grpc is not being used.
00:04:07 [W] For example, that's the only only one connection between the predication and the proxy. So the connection management feature within grpc is not being used.
00:04:16 [W] There are some other potential problems caused by the proxy one of them is performance.
00:04:22 [W] So there will be one proxy on the client side and one on the server side.
00:04:27 [W] This can add overhead. This can add latency like and also also proxy could become the bottleneck of the system if your applications are fast enough.
00:04:38 [W] Another problem is that the proxies are Standalone binaries that new tip that need to be deployed along with the application.
00:04:46 [W] So this means you are also need to manage the lifecycle of the proxies.
00:04:51 [W] You will need to deploy them to upgrade them and also to help check them a third problem is you are not have into insecurity because the proxies in between need to enter in to intercept the traffic and into insecurity could be
00:05:06 [W] Another problem is that the proxies are Standalone binaries that you teach people that need to be deployed along with the application.
00:05:13 [W] So this means you are also need to manage the lifecycle of the proxies. You will need to deploy them to upgrade them and also to help check them a third problem is you are not have into insecurity because the proxies in
00:05:53 [W] situations
00:05:56 [W] so because of those problems we were thinking if we can add servicemeshcon into grpc, so we don't need those proxies and this leads to a proxy last grpc servicemeshcon.
00:06:25 [W] Is and the module we added in your grpc cook can understand the conflict the configuration from the control plan. So it will do all the features that was down by the proxy.
00:06:39 [W] There's actually one more thing to decide before we can move on in the proxy based model.
00:06:45 [W] You can pick the proxy and the control plan impaired, but this will be a negative about of of servicemeshcon within grpc.
00:06:53 [W] So we actually need to decide which servicemeshcon support and and as always what matters most is not the implementation is the API and this is the API between the application and the control panel where the configuration is exclusive.
00:07:08 [W] Just so we want to pick an open and popular API that has very strong Community Support.
00:07:16 [W] Is XDS XD sap is what developed for Envoy an Envoy is used by many popular servicemeshcon plantations of the proxy.
00:07:27 [W] So this makes XDS the de facto standard for data plan apis for servicemeshcon.
00:07:36 [W] This is an overview of the XDS apis.
00:07:39 [W] I'm not I'm not going to get into too many details of those look at the protocol, but I want to give an overview because it helps us understand the demo at the end from bottom up. The first thing is in point. Any point is
00:07:54 [W] It contains the so address and also whether the Soviets healthy.
00:07:52 [W] Above low quality above and point is the quality. The quality is a group of employees.
00:07:58 [W] You can understand as a zoom and a special thing that recorded can do is priority.
00:08:04 [W] So let's say we give this locality p 0 and this is P1. The the low priority lower part of the country is only used when the higher priority is not healthy.
00:08:15 [W] And we'll have a demo to show this at the end.
00:08:19 [W] About locality is cluster a cluster. You can see it as a deployment. And by the point it can be you can have deployments for different Services.
00:08:30 [W] You can even you can also have deployments for different versions of the same service.
00:08:35 [W] So this can be helpful. If you have two versions of the same service and they are migrating from one to the other and also Caster is where load balancing is configured. So this blue box to a container holds you to the Past.
00:08:48 [W] Between local areas and uneven for any points with thing locality about locality is the rule is the Lord root.
00:08:58 [W] So this is where required rotting is happening.
00:09:00 [W] This is where you are do pass matching have the matching you can stand specific traffic to certain cluster or even you can do traffic splitting between two clusters and this is also where timeout we try and other kind of
00:09:15 [W] For the four southern route is configured about route is the listener and virtual IP.
00:09:17 [W] So this is the part that makes most sense from a proxies point of view because as a proxy all the traffic comes from a listener from a virtual IP, and this is where the configuration for this for the for the traffic
00:09:32 [W] I figured but this doesn't doesn't apply very well inside India pieces. I'm not going to talk too much about that.
00:09:23 [W] Many of the XDS features are already available inside grpc and to enable those features you have to do three things.
00:09:31 [W] The first thing is to pull in the XTS dependency XTS dependency is not part of the grpc cool because we don't want to have unnecessary code for those people not needing XPS. So you are have to explicitly add the dependency.
00:09:47 [W] The second thing is you all have to change the the resolver scheme to XTS.
00:09:53 [W] This tells the grpc client to use Legacy has resolver and real Argo will then trigger all the other components like the load balancers for xes a start things. You are provide a bootstrap file. This file have the XDS
00:10:08 [W] And you can also specify other configurations. I could you can set a node ID to identify this kind.
00:10:15 [W] There are some limitations of the proxy less subjective servicemeshcon.
00:10:20 [W] Is there still a feature gap between what grpc can do and what the proxy is like envoy can do the XDS API is a very rich set of services and we are still actually actively working
00:10:35 [W] can do and what the proxy is like Envoy I can do the XDS API is a very rich set of services and we are still actually actively working on adding those amazing features a second
00:10:43 [W] Amazing features a second thing is that you are still new to deploy a poster fire with the application but comparing to deploying a proxy.
00:10:54 [W] This should be much simpler. Next is that there is a big ecosystem around Envoy, especially regarding to observability, but fortunately many of those plugins are also available as grpc.
00:11:09 [W] And open cells and and staff handles like open sensors.
00:11:13 [W] And also we are actively working on observability supporting XDS.
00:11:19 [W] The last thing is that you are new to recompile recompile the vacations because as I said, you are need to explicitly at the XDS dependency, but this should not be a problem is we if you already have a ci/cd system.
00:11:33 [W] And another thing I want to say is that you don't need to migrate all your applications to proxy let Roxy layers at once even within the same application. You can have you can set different resolver schemes for different grpc channels.
00:11:49 [W] You don't need to migrate all your applications to proxy let Roxy layers at once even within the same application. You can have you can set different resolver schemes for different grpc channels.
00:11:57 [W] So the channels using XDS resolver will use the xes modules within grpc and those use less than use DNS resolver will still go through the proxy if you can figure that way so it is pretty easy to
00:12:12 [W] So the proxy if you can figure it out way, so it is pretty easy to setup a mix-and-match proxy and proxy less deployment.
00:12:19 [W] And also another thing I want to say is that the goal of proxy last grpc servicemeshcon not to put the proxies like Envoy out of business.
00:12:29 [W] It's more like to provide an alternative to coexist with the proxies. If you have none grpc application is you will for sure still use them the proxies and even for the
00:12:41 [W] Opposite applications in some situations it might make more sense to go through a proxy.
00:12:49 [W] so as of October in grpc release, 1.33 our exteriors client already exposed the form an access services, and also with the public reporting realize note that this means this
00:13:06 [W] so as of October in grpc release 1.33 our XTS client already exposed the form an access services and also with the public reporting realize note that this means this
00:13:32 [W] X DS version V2 and V3 in terms of features will support the load balancing with in localities and revising for localities.
00:13:43 [W] We also recently added support for past matching had a matching and traffic splitting.
00:13:50 [W] So those are the things that we are actually working on working on timeout secure working for injection.
00:13:56 [W] We also working on adding XTS support on the server side to add a big features security and observability. You can watch the progress and get up. You're also you're also very welcome to contribute.
00:14:11 [W] This is a list of resources that protectors are included the grpc design Doc's here in case some of you might be interested in how the XTS implementation is done within grpc.
00:14:24 [W] So that's enough of talking and we'll do a demo to show how this works in practice in this demo.
00:14:32 [W] I will use grpc wallet.
00:14:34 [W] This is an example in replacing with created to show all the features and for the control plan our use traffic Vector. This is Google's managing servicemeshcon troponin, and I'm not going to show you exactly how the configuration for
00:14:49 [W] Like I almost had to show you the sit the subway setup and that the and then show you what the current can do.
00:14:57 [W] So some context for the grpc wallet application. So grpc Wally.
00:15:03 [W] There's a world full of special coin called grpc calling. We all have three services here the account service.
00:15:09 [W] This is where the user information installed the staff service.
00:15:13 [W] This is where the price for grpc coin is recorded and the wallet service. This is where the number of grpc calling for each user is stalled. So the client can make a price call to the status of it's like the green
00:15:27 [W] Miles, so the kind of lost and the user information with grpc, then the steps of is to our verify with account service for the information and then based on the real response.
00:15:39 [W] You will send the files back to the kind the kind can also talk to the Warriors of is to get a balance for user then similar to the files called the kind will also send you the information and the water is always will verify with the
00:15:54 [W] Stand the user information with grpc, then the steps of as well verify with account service for the information and then based on real response.
00:15:52 [W] You will send the files back to the kind the kind can also talk to Wally a service to get a balance for user then similar to the files called the kind were also sent me with information and the water surface will verify with the
00:16:24 [W] And all and then the slowest service will send a PC to the status of ways to get a price So based on those two responses. What is a resource and the balance responds with number of jobs recordings and the total Wars of the grpc coin to the kind.
00:16:42 [W] The first demo we're going to show is traffic splitting.
00:16:45 [W] So in this demo the client will talk to the warrior service to get the balance and we are create two deployments of the vale service V1 and V2.
00:16:56 [W] Imagine that you are migrating from V1 to V2.
00:16:59 [W] V2. And before you before you are confident that V2 is is stable enough. You want to split traffic between with you so we config grpc fetch balance to send 60 percent of the traffic.
00:17:12 [W] Delete Y and 40% to way to and and as the way tube the videos obviously getting stable unstable.
00:17:20 [W] You can greatly increased subjectivity.
00:17:22 [W] So so this is our very kind here and we're going to run this command to tell the client the client to just talk to the warrior service to get the balance
00:17:37 [W] Ways that the xes scheme Rodolfo scheme here to to use the XDS?
00:17:43 [W] raghava and also it how it to make the unary offices in a hole so we can see the different responses from different patterns. If we've done that we'll see those responses from V1.
00:18:01 [W] And there's one from V2.
00:18:08 [W] So you'll see that the distribution is not exactly a 60% and 40% but you will see that they are more traffic from way to than from V1 and V2 because the problem we used here is not is random best wet it won't open.
00:18:23 [W] That leave the comfort in you said but you can't but this is definitely the most traffic from V1 and V2.
00:18:19 [W] Okay.
00:18:19 [W] So the next demo is had a matching in this demo.
00:18:24 [W] We will use the client to talk to the staff surveys to get the price and we have we also have two deployments of the status of is just a service for normal users and the status will only for premium users the Prometheus get surprised update with
00:18:39 [W] The kind who was that on the infuser information with the PC. It also includes whether this user is a premium user or not.
00:18:37 [W] And then based on the header will route the premium request to only the steps the steps premium service, so
00:18:50 [W] So around this command.
00:18:54 [W] So run this command to tell to tell the client to talk to the staff service to get the price and also with there's that the exhales readable scheme and we are using both as the user in this command. Bob is a normal user.
00:19:10 [W] So if we run that we can see this the response comes comes back from the steps of is if you want again, it should still come from the status of is rather different packet.
00:19:22 [W] So if we change this to use the Alias or see that responses from a stats premium caster and and then also the updates is more much more frequency frequent.
00:19:38 [W] So that's had a matching and the set them over going to show is fell in fact silver is the priority feature of the qualities. I just I talked about in the xes overviews overview side in this demo.
00:19:53 [W] From a stats premium caster and and then also the updates is more maximum frequency frequent.
00:19:57 [W] So that's had a matching and the set them over going to show is fell in third world is the priority feature of the qualities. I just I talked about in the xes overviews overview side in this demo.
00:20:11 [W] We're going to run the kind in US Central and what when you start multiple Services some of them in US Central some of them in u.s. West the the logic here is if the client and the server understands own the
00:20:26 [W] The servant from the seldom will have the higher priority. So yes, since your servers will have part is 0 and U as well as to the serverless will have Priority One.
00:20:35 [W] we want to see is that all the traffic will go to your sensual at first. So now all of the year as well serverless should receive any traffic and then we're going to turn down the servers from u.s. Sensual and then the traffic will go to u.s.
00:20:49 [W] West and the
00:20:51 [W] so this is the setup I
00:20:55 [W] so this is the wallet client and this is the server from us Central.
00:21:01 [W] This is also essential this is uswest. This is usually as well. So if we run this command tell the tell it to talk to the staff surveys to get priced and also run the unit grpc in a for Loop.
00:21:18 [W] We'll see both the US Central servers are getting traffic but the u.s. West of us are getting nothing.
00:21:24 [W] So if we kill one of the US Central servers, you'll see the the the other us Central server. You're still getting all the traffic, but the you as well start getting nothing. So if we kill this one as well.
00:21:37 [W] Server from us Central.
00:21:40 [W] This is also essential this is uswest. This is your first as well.
00:21:44 [W] So if we run this command tell the tell it to talk to the staff surveys to get priced and also run the unit grpc in a for Loop.
00:21:57 [W] Well, see both the US Central servers are getting traffic, but the u.s.
00:22:01 [W] West of us are getting nothing. So if we clear one of the US Central servers, you'll see the the the other us Central server are still getting all the traffic but the u.s. Wells are getting nothing. So if we kill this one as well.
00:22:16 [W] Let's see that in the US the west of us are getting the traffic now and this field what happens fast because the u.s.
00:22:23 [W] West of us already Stand The Collector to the kind that they are just a lower priority.
00:22:26 [W] So now if we restart the US Central servers the traffic should go back to our tool u.s.
00:22:34 [W] Enjoying a minute and this is slow because the control panel need to do Health Shake of those servers and the traffic it will only go there Windows Server Windows servers are healthy.
00:22:45 [W] So you can see one of the u.s. San Jose always already recovered and the other one is taking a little bit longer.
00:22:58 [W] And now and now the traffic got all recovered from for the US Central service and also is doing wrong moving between those two servers.
00:23:08 [W] Okay.
00:23:11 [W] All right with that that's the end of this presentation.
00:23:16 [W] So if you have any questions, you can find me and also you can find the grpc team here. And if you have any questions, let me know. And yeah.
00:23:40 [W] Hello again everyone and thanks for joining this session. We will have several minutes for questions. And if you have any questions Post in the chat window, we have one question here just to clarify XDS.
00:23:54 [W] I Phi X DS is been peeled into grpc directly and won't be a separate optional dependency, right and doesn't affect the grpc protocol itself, but only grpc serverless patient's grpc is being built into the grpc library.
00:24:09 [W] A separate package, but there's not another binary like the proxy So you you're still have a knative grpc application and this application. We all have the XDS module to talk to the control button and then get and
00:24:24 [W] Questions. So this does not affect the grpc protocol if you want to get him or a bit more details.
00:24:31 [W] It's billed as a result of and balance theory on today on the client side and we are going to also build modules on the server side you supporters. So yeah, it doesn't affect the grpc protocol.
00:24:47 [W] And and also just as a note this presentation will be available after the live this live show on demand in this platform. And also if you want one the links the demo links and other things from
00:25:02 [W] It's the size is available on the top page and it has all the links.
00:25:11 [W] Yeah, the code is it has the code to link to the GitHub repo with all the code
00:25:20 [W] So some of the server side next year's the future will working on now is security so that's our kind of next Milestone. And after that we're going to also do like observability and all while trying to
00:25:35 [W] Pioneer Way is XDS.
00:25:30 [W] So whatever is Envoy, so whatever I can do today is kind of we are trying to get into the same situation. So yeah.
00:25:50 [W] There's another question our services able to Define where when they are ready after startup. So the clients don't send traffic to soon so you can configure the control plan to tell the client that the
00:26:05 [W] There's another question our services about to Define where when they are ready after startup. So the clients don't send traffic to soon so you can configure the control plan to tell the client that the so the like one and points
00:26:21 [W] Not healthy, for example, so the kind won't send traffic to this one so you can build house check into the system so that you can put the basically control when the current will send traffic to kind of like a subset of the end points.
00:26:44 [W] any more questions
00:27:06 [W] I want to thank everyone again for joining this session. And if we don't have live questions now, I will be available in the in the slack slack channel for any questions and also you can always find me a from GitHub
00:27:22 [W] The grpc io mailing list.
00:27:26 [W] So there's another question any ideas of Maintenance of other languages are working on similar features.
00:27:32 [W] Oh, I forgot to mention.
00:27:34 [W] So all of those things I talk about are already available for grpc go C and Java and and also some other long dropping dropping multiple languages like python Ruby and those like that are built on top of
00:27:50 [W] I say go C and Java and and also some other long rope dropping multiple languages like python Ruby and those like that are built on top of see also got those features as well.
00:27:53 [W] So basically all the grpc languages in the grpc organization get those features.
00:28:23 [W] How much overhead this was introduced to the surveys I'm Imaging that will be background threads refreshing ex-convicts.
00:28:30 [W] One of the benefits are proxies to keep the applications to build and provide unified Network inferior. So this this definitely will add some kind of overhead because the yeah because as is as you said the client
00:28:44 [W] Crashing one need to keep a stream with the XDS server and then get the configuration. But I believe comparing with separate proxy binary.
00:28:55 [W] think this should still get you some performance benefits.
00:29:34 [W] Okay, I think well I don't time on this.
00:29:37 [W] Thank you again for joining session and I will be available in stock select.
00:29:41 [W] Thanks.
