Contributing to Kubernetes Conformance Coverage: MAKG-4397 - events@cncf.io - Thursday, November 19, 2020 3:46 PM - 33 minutes

Participant: wordly [W] English (US)

Transcription for wordly [W]

00:00:00 [W] Hello and welcome to contributing to kubenetes conformance coverage.
00:00:33 [W] Hello and welcome to contributing to kubenetes conformance coverage.
00:00:38 [W] I'm with III and we're a coating Cooperative in New Zealand with a focus on Cooperative coating pairing is sharing through us and any time two or more of us are together cooperating on things
00:01:16 [W] And any time two or more of us are together cooperating on things than the where is their right?
00:01:22 [W] So the people of the coop or myself and my friend Caleb who is co-hosting this talk with me and our friends stackrox has on the UI and the database and many other pieces
00:01:37 [W] The down in Wellington focuses on the UI and the database and many other pieces Stephen Haywood does a lot of test writing and the client has two brothers separated by a continents during covid are collaborating on the prowl and the project
00:01:53 [W] Staring covid are collaborating on the prowl and the project management.
00:01:58 [W] We're going to focus on two major components the intro and the Deep dive and then the intro we're going to ask some questions about what kubenetes been performances and how to participate and wrap up at the end by showing
00:02:14 [W] submission passing
00:02:18 [W] First question you might have is what is kubenetes compartments great question.
00:02:23 [W] It's good to have expectations about the kubernative IPI. So it can behave the same way regardless of who's hosting it for you.
00:02:31 [W] I know it's important to me to have my workloads run everywhere that I see the kubernative logo.
00:02:37 [W] Luckily, we have a conformance website that walks everyone through the process of understanding what it is that kubernative certification provides and how to participate are deep.
00:02:47 [W] Dive will go a little further into that during this intro.
00:02:50 [W] We're going to go through the conformance repo and create a new folder underneath one of these starting back at 1.9 through 1.19. The we only I think allow the last few releases to be certified as
00:03:05 [W] Corded why is Kuma Nate's conformance important because vendors shouldn't matter about workloads.
00:03:11 [W] That's fair. I would expect my stuff to run anywhere regardless of been there the combination forwards program kind of ensures this Force, but now that you've got these Kate spec patient's might be able to meet them for you.
00:03:26 [W] Course, but now that you've got these cakes suspect a shins might be able to meet them for you.
00:03:23 [W] Yeah.
00:03:24 [W] Oh, there's about sixty seven or more quite a few.
00:03:29 [W] that's great. It's cncf actually has a landscape where you can go to the website and click on the certified case providers link on the left and look at this long list of providers that can meet your Kate's picked ations.
00:03:42 [W] wanting to get on that list, you might be asking well, how do I certify my Kate's?
00:03:46 [W] - great question.
00:03:49 [W] So this is some public instructions on this if this is if this is you so what you'll need is four different files one of them being documentation on how to make this reproducible.
00:04:03 [W] They'll be some product metadata and then they'll be two types of logs that you need.
00:04:07 [W] need. Why don't we go through and get some stuff? So don't I like that I have we have the the readme from the
00:04:17 [W] Find Sig that's submitted their for files about seven months ago for 118 and their documentation includes how to run it.
00:04:26 [W] We will go ahead and change our view to include that and walk through the steps. We've just created a new son of Y. So, we're gonna look at the logs for that as well and the lungs will allow us to probably see that test running.
00:04:41 [W] And they will create some output for us.
00:04:44 [W] But while we're waiting for the output, maybe we could look at the Cuoco the sonobuoy namespace.
00:04:52 [W] Well, let's look and see what's there and the watch you can note that there the son of way pod run along with all the normal X beta cap did environments including oh this API Snoop that might come in portent later.
00:05:04 [W] Yeah. Remember that son of mine will export some results including the to log files that you will need and will
00:05:11 [W] I'll do a quick check to make sure that those log files do exist. And they do excellent. So combining the files we need to submit our conformance results the instructions that they
00:05:26 [W] And focus on the website here that shows uploading the files and the fields that you'll need to fill in your product demo that will be part of our PR that we upload in order to create that
00:05:42 [W] you need to go back into our terminal window and show our forking of the case conformance repository as well as adding a remote to push our changes to the branch doesn't really matter, but
00:05:48 [W] Name of your product and the version because that will be this results that we do submit.
00:05:51 [W] The next step is to copy those results into place and combine them with your theory me and your product demo and if we push those through that will allow us to create a branch to create a
00:06:07 [W] P r so this is the example PR that includes are not kind version with some URL information for our logo as well.
00:06:18 [W] As our readme that does not yet include nice instructions and those two logs.
00:06:21 [W] So if we click on create pull request, there's a pre-submission checklist that you can go through the sorry Phil uppercase informants, but for our demo here, I'm actually going to file this against the cncf infrared k8s conformance and go ahead and look at the
00:06:36 [W] We're creating based on that.
00:06:37 [W] We'll come back to this a little bit.
00:06:38 [W] later in the demo, but this contents of the pr contain these four files that are part of the documentation and will visit that again after our Deep dive.
00:06:53 [W] Thanks for that Caleb are deep dive is going to consist of several things regarding the gaps that we have in kubernative conformance coverage three main things identifying those gaps closing those gaps
00:07:08 [W] Anything the Gap so we can color in all of the parts.
00:07:04 [W] That are missing.
00:07:05 [W] First identifying the gaps and kubernative coverage is going to require filling in our thank you filling in our graph here.
00:07:17 [W] API snyk dead cncf that I owe is built on top of a database that looks at the entire surface area of the kubernative API and lets us see the operations that have
00:07:32 [W] Look at the entire surface area of the kubernative API and lets us see the operations that have conformance coverage, which is the darker color and test coverage.
00:07:40 [W] That's not yet conformance, which is a lighter color and the gray areas which have no test coverage at all.
00:07:46 [W] You can see that there are quite a few gaps. We'd like to fill in particularly in the greens. They will area these are the areas that
00:07:56 [W] That we focus on as far as the gaps the underlying database that we use to create that graph is called snyk DB and it has a few schemas that are populated from public data
00:08:11 [W] First of all, we pull in the Swagger Json that is from the kubernative Repository.
00:08:17 [W] Usually for the branch that we're focused on getting data for and conformance EIG olives that we have to configure to generate text.
00:08:27 [W] Json file logs that are including policies logging all the events were interested in auditing.
00:08:35 [W] The last part is some testing schemas that will help us when we're trying to write tests or get data in a live cluster situation.
00:08:45 [W] You might be asking yourself how I can ask and answer my own questions deploying Snoop TV.
00:08:52 [W] It's a great question.
00:08:53 [W] Well since others actually many ways to deploy API Snoop, you can use your own clusters or you want to do some local testing with it and figure out the endpoints that you care about then you can deploy
00:09:05 [W] Kind using this configuration that we have as you climb the API snyk repo check out the kind folder.
00:09:11 [W] There's a neat little configuration that just might be for you which would bring up API soup and autologous straight away.
00:09:18 [W] What's great about having this local to you is you can ask any of the questions were asking in the DB and modify them to ask your own questions and get results without having to wait for us to come up with a solution
00:09:34 [W] That we're going to focus on first are the audit events and the open API. The open API is pulled from that Swagger Json that's in the kubernative repository.
00:09:44 [W] I think it weighs in at around 2 mags normally, but once it's loaded into the database with all of the indexes and extra data in ways in and around five mags on the other hand the audit event
00:09:59 [W] Is pulling from probably 2 to 5 gigs depending on how many repository how many see I jog as you're pulling from but tends to consolidate down fairly nicely because of the amount of overlap and Fields.
00:10:04 [W] We load the Swagger Json directly from the GitHub repository for kubernative.
00:10:11 [W] And this allows us to have a table based on just the shape of the kubernative API to be really clear and precise about what it is.
00:10:22 [W] We're trying to make sure that we cover without having any logs. This allows us to do as you could and example P SQL query that focuses on the release of coming called 120
00:10:37 [W] Belen points to just show us what's brand-new and stable in this next release.
00:10:39 [W] Let's keep an eye on this get internal API server group because it'll be important later in the presentation when we have some UI elements to show.
00:10:49 [W] In addition to the surface area. We have this big gray underlying thing. We need to color in the areas that we are actually testing Snoop DB has a second phase. It goes through instead of Beyond loading just the
00:11:05 [W] API definition, it also loads test that data the kind conformance audit job was created this week in order to create an audit log you can see
00:11:20 [W] That the audit log that it creates there is brought in to our API Snoop DB so we can have all of these tests and see all the endpoints that it hits.
00:11:24 [W] The database table underlying that that ingest those logs allows us to know and query the test whether that test was a conformance tests or not and all of the raw Json
00:11:39 [W] That is part of that audit log entry.
00:11:42 [W] So we have access to everything that's available in the kubernative audit logs to query and combined with the surface area.
00:11:54 [W] as of this morning, we were only using a couple of jobs to inform our
00:12:01 [W] our coverage and that was the CI kubernetes GCE conformance latest and the EGC igz job.
00:12:11 [W] If you look tomorrow, it'll include the kind job as well.
00:12:17 [W] Those are all available publicly on proud. So when you load up smoothly be it will retrieve them and put them into your local instance of Snoop TV.
00:12:28 [W] We had to create some changes to the ed test framework and the API server. In order to have our tests show up in these audit logs.
00:12:42 [W] First of all, we had to ensure that the e2e framework submitted a user agent that changed based on the current context of the ginkgo test that it was executing.
00:12:53 [W] your local instance of DB
00:12:51 [W] we had to create some changes to the ed test framework and the API server. In order to have our tests show up in these audit logs.
00:13:06 [W] First of all, we had to ensure that the e2e framework submitted a user agent that changed based on the current context of the ginkgo test that it was executing.
00:13:18 [W] That allowed the user agent to be transmitted and picked up by a pi server, which previously did not include the user agent in its laws.
00:13:27 [W] So our changes there enabled the user agent to be ridden all the way through so we can pick it up in the database.
00:13:36 [W] The conformance tests are now able to be queried by just looking through the audit event table and finding where we have unique tests that have conformance. For example.
00:13:49 [W] If you remember earlier, we had that give us the new endpoint in 120 that's table.
00:13:53 [W] This is the front page of API Snoop that if you go down to the bottom of any of the releases that you can select from you'll see that list of new endpoints.
00:14:04 [W] It's pretty obvious that there is a new category being brought in and 120 called internal API server, which has a slew of Alpha and points which will need to eventually as they progress from alpha to Beta
00:14:19 [W] Stable to reach table will need conformance tests, but for now this allows us to have some anticipation and communication with them probably with whatever Sig is part of internal API server to let them know.
00:14:32 [W] Hey, we're going to need to have conformance tests before it's part of the public release of kubernative.
00:14:41 [W] Historically we have about three years of the conformance program. It started back in 1998 and we began to label and text the conformance tag for our
00:14:56 [W] Before it's part of the public release of kubernative.
00:15:02 [W] Historically we have about three years of the conformance program. It started back in 1998 and we began to label and text the conformance tag for our
00:15:17 [W] Anytime you see red that's new conformance tests that take care of old grade debt.
00:15:23 [W] The orange areas are where we introduced new and points and didn't include any tests. This makes it hard is it makes the whole crate digging deeper while we're trying to fill fill it in so
00:15:38 [W] We're lucky in that from 115 onward.
00:15:40 [W] We don't really see a lot of new implants being promoted without tests and we'll show a little bit later.
00:15:47 [W] We're ensuring that that will never happen again.
00:15:50 [W] The red is where we have written test for old and points in a race that debt and we color in that gray area with red and that reduces our gaps in coverage.
00:16:03 [W] The last slide around identifying is showing our current conformance debt all the way back to 1/5. We hope to clear all of our dead back to 111 by the time we cut 120.
00:16:18 [W] Finally, we're going to go through closing gaps and kubenetes conformance coverage and I'm going to turn that over to Caleb. Yeah, so we've got this flow going through and finding those end points that need those tests and
00:16:33 [W] Fine.
00:16:30 [W] hope to clear all of our dead back to 111 by the time we cut 120.
00:16:37 [W] Finally, we're going to go through closing gaps and kubenetes conformance coverage and I'm going to turn that over to Caleb. Yeah, so we've got this flow going through and finding those end points that need those tests and
00:17:10 [W] That is again.
00:17:11 [W] So we start off with this query to focus on the specific untested in points here where we're searching for five stable coredns points that are eligible for conformance, but a lacking in tests
00:17:27 [W] The endpoint we want to go to the reference dogs and to understand the API endpoint and yeah, shout out to Sig dogs doing great work.
00:17:36 [W] We want to understand the way that we can talk to the resource and all of its function handlers.
00:17:44 [W] So we got a client go for that which is really useful and we look in the core V1 folder. Here's an outline of the test and the way that will write the test. So this is often a life cycle.
00:17:56 [W] I love the the resource we use this quite often as you want to hit more endpoints.
00:18:02 [W] This is allows discussion of the approach of the test without needing to write out a fully fleshed test or even any mocked as just a high-level discussions for the conformance sub-project.
00:18:15 [W] Yeah, and once we've done that that point in the same ticket, we're able to shown an example because at this point we don't want to use the eat we test Suite because we want we want to be able to
00:18:27 [W] Display what we want to do is tickets to make it really easy to discuss.
00:18:30 [W] So that is all before creating a PR and then next on we run mock tests and our local clusters and we make sure that
00:18:46 [W] Live test rider this allows us to see the new untested endpoints which we want to Target a no tests and then following on WE we've noticed that this test wasn't effective enough
00:18:59 [W] Following on WE we've noticed that this test wasn't effective enough creating a pot because pods there are already covered in conformance.
00:18:57 [W] So we don't get any changing coverage that which is fine.
00:19:01 [W] So we'll look again for more influence later on now that we've got a ticket it's the by this point you should have end points which unhit and you've proven that you can hit them in your garden.
00:19:17 [W] Some code that actually does do that now we can submit a ticket and in this screen shot right here.
00:19:25 [W] We have a whole bunch of issues on GitHub that submitted as tickets and they're exporting this markdown and they're all ready for review.
00:19:35 [W] that's what it looks like to find find those endpoints which haven't been hidden create a test for it.
00:19:45 [W] It's great to have a team focused on filling in all of those gaps.
00:19:49 [W] I know that Caleb myself and Stephen and a few people within the team have been able to write those tests and fill it in.
00:19:56 [W] But the next thing we do is making sure that are preventing new gaps from forming and communities coverage.
00:20:03 [W] We work a bit with the testing and proud infrastructure and particularly test grid and creating some dashboards for the Sig arch conformance subgroup of cigarettes.
00:20:15 [W] Two things are conformance audit is the new Proud job that generates audit logs. But we also have the conformance gate and the API Snoop conformance gate
00:20:30 [W] We'll be sending emails to the group of folks interested in conformance test failures so that we can eventually filter this to a release blocking compartments job so that we can signal to the
00:20:31 [W] Sig release that there is a new API that has come through without conformance tests. We do that so that there's time to either revert that back into beta or ensure that the tests are fully written
00:20:44 [W] For that new API can be part of a release.
00:20:47 [W] To summarize our Deep dive was all about the gaps in Kuma Nettie's conformance coverage where we would identify the gaps using API Snoop dud cncf that I owe with the underlying snyk DB we were able
00:21:02 [W] Those gaps using Hue Max and are in cluster workflow that the i-team uses and we were able to prevent gaps by creating our release blocking jobs.
00:21:14 [W] So let's back out of the Deep dive for a moment to verifying the communities conformance emissions.
00:21:22 [W] We're using a bit of proud cncf that iot for that note that that is the cncf Sprout instance versus the kubernetes communities instance, but this is our about our PR submission from earlier.
00:21:36 [W] The results gets submitted to the cncf could Kate's conformance repository and initially we reviewed by humans and it's a lot of work and then we wanted to make sure that we validated that
00:21:52 [W] Proud cncf that iot for that note that that is the cncf Sprout instance versus the kubernative communities instance, but this is our about our PR submission from earlier.
00:22:03 [W] the results get submitted to the cncf
00:22:07 [W] could k8s conformance repository and initially we were used by humans and it's a lot of work and then we wanted to make sure that we validated that it was ready for just a thumbs-up approval that was
00:22:56 [W] just a thumbs-up approval that was had metadata around it and our bot that is powered by a proud plug-in that we wrote goes through and validates that the title and the logs and
00:23:11 [W] Are all following the protocols and they're all run in this case.
00:23:16 [W] We have a required test missing label and that's because in order to speed things up the test that we ran earlier for sonobuoy against are not quite kind deployment was
00:23:31 [W] One test. So obviously it didn't pass the communication might be please try again.
00:23:33 [W] And here's the directions for running it but fear not many other certified distributions have been successfully adding the label of test verified for the release.
00:23:43 [W] They were interested in which allows the cncf to go through and improve those merges and let you to use the certified logo for kubernative.
00:23:55 [W] That's pretty much it.
00:23:56 [W] Here's the main links that we talked about during this talk for these cncf certified kubernative repository the API Snoop website the test grid the two repositories within the cncf
00:24:11 [W] performance results and the work that the API Snoop team does
00:24:15 [W] We'll open up the Q&A now and kill, but I will see you in the TOC.
00:24:27 [W] Hey, hello, everybody.
00:24:30 [W] Hope you enjoyed the live demo that we recorded earlier.
00:24:34 [W] I was really neat to see the progress that's even happened since our our presentation.
00:24:43 [W] Are there any questions?
00:24:45 [W] I didn't see anything pop up in our our chattery. If not, we can kind of self seed some of that.
00:24:57 [W] Might be useful to share my screen of not done this before on this platform that will give it a go.
00:25:04 [W] And this is our a link to our Toc not sure if I can share this with folks, but I'll drop a message in there until you try these are all of our slides you can get through at a later time.
00:25:22 [W] And apis do the cncf dot IO has a landing page that has a lot of the kind of summarization of the conformance program for this particular release and and all the
00:25:37 [W] It's really exciting to see runtime class, which was newly stable, please our new implants and they are also conformance testing them out the link into to slack about that.
00:25:46 [W] also on Twitter
00:25:40 [W] look at I'm Tippi hacker on Twitter some good friends of mine.
00:25:44 [W] Hello. Delphine friends.
00:25:48 [W] Here is our congrats to surgery and crew on being able to get their promotion. What's fun about this?
00:25:54 [W] Is that kubenetes enhancement process?
00:26:01 [W] The kubenetes enhancements repo has cast and those kept start at the beginning of the process is one that started in 2018 and I have a few questions coming through we did.
00:26:16 [W] Questions are there we go, beautiful.
00:26:16 [W] You want to read it out?
00:26:17 [W] Yeah. So the first question is Sig's required to ensure that their own API endpoints are getting hit by components tests.
00:26:27 [W] We have some gateways where we were any new apis are forced before they're allowed to be GA that they have to have conformance tests.
00:26:39 [W] And that's part of what I was looking at here with our runtime class. This kept open in 2018, the they wanted to GA in 120 and we used API statements.
00:26:50 [W] and he are blocking jobs to ensure that that happened and this is kind of like a gradual Tori. Yay. They
00:26:56 [W] That Sig was able to bring their runtime class to ga.
00:27:03 [W] so, yeah, I guess the end that the those who are reading and caring about the end points should aim to make sure that they have their own components this ribbon and
00:27:18 [W] Without that the rest of the community. So if you have new friends that you want to introduce then conformance tests are required at this point
00:27:31 [W] The next question is can you talk about some of the specific categories of where you need to prioritize?
00:27:34 [W] what conformance tests to be clear conformance and performance sound similar? So I want to make sure we're talking about performance test.
00:27:43 [W] I am not sure that conformance is part of conformance at this point. Primarily our our measurement area comes
00:27:54 [W] From the Swagger API.
00:27:56 [W] So this entire set of API groups here are actually the operations that are defined in and Swagger and we want to ensure that all of those that reach the stable and point get covered so you can
00:28:11 [W] The ground zoom in a bit to see these are the are still completely untested.
00:28:12 [W] So for us around prioritizing it's less around performance and more around filling in the gaps and ensuring those gaps aren't increased by adding more endpoints without tests.
00:28:28 [W] And we also focus on core until it's and so it had all of the coredns points.
00:28:36 [W] There are some things around we can hit some coredns points, but there's been lots of discussion about the Nova the years and getting as many through this we can
00:28:51 [W] Hi, enjoy the talk.
00:28:53 [W] Can you talk some more about Kuma X and how they relate sure before I go on to the Hue Max question.
00:28:59 [W] I wanted to note there is a list of ineligible and points that are stable and it has reasons on why they aren't there yet because your may eventually come back and if those underlying requirements change, one of the things that underlies our technology
00:29:15 [W] Laser may have actually come back and it does underline requirements change.
00:29:13 [W] One of the things that underlies. Our technology is is Hugh Max.
00:29:18 [W] And what if you Max is technology that we use is basically emacs but very custom configure of it that we deploy into the kubernative as a
00:29:34 [W] Inside of clusters that we create for writing our conformance tests the when we spin up our clusters we turn on audit logging that logs to a
00:29:49 [W] that locks to a database and our workflow uses this container from this Hue Max repository and we have a separate area inside of a github.com API Snoop
00:30:04 [W] Ticket writing repository and this repository has ordered files and these ordered files are the workflow that we use to start from.
00:30:15 [W] What was it is is effect a template available where we have a checklist of creating a network file creating an approval issue. And what's interesting is all of our issues are originated from these orc files in cluster
00:30:30 [W] keystrokes to populate that into your clipboard so that you we paste to create those new tickets the first step being in the select to be of the database in apa Snoop that comes from his recent jobs the
00:30:44 [W] we should focus on next and you kind of write your query and hone it down to what you would like to focus on find the docks create a simple outline and then write a simple code block, but since we're inside the
00:30:56 [W] Truly Cloud native development when we run this code block, it actually generates audit logs, which we query later to get the results to say this actually increases coverage.
00:31:06 [W] The reason that we use Hue maksud ish Ali is that it supports screen sharing via SSH and web.
00:31:15 [W] So when we do this we often do it together, which is at the beginning of the presentation you saw that for us pairing is sharing and the we try
00:31:24 [W] To always get two or more people working on the thing together so that there's not isolation of the knowledge. And since we do record everything as order files that export the markdown the knowledge gained by those two people spending time together is
00:31:43 [W] Next question. The next question is how do you ensure that no endpoints of Madrid GA work components test.
00:31:48 [W] That's an excellent though.
00:31:50 [W] We noticed earlier. We had our thank you to search a and the team for the promotion that there might ask how to how do we make sure that that didn't happen?
00:32:00 [W] It was in the presentation a bit, but we'll go back to the test grid test grid has a set of dashboards and under cgroup.
00:32:09 [W] Architecture, we have created a Sig Arch conformance the job and it's currently failing.
00:32:19 [W] Yes.
00:32:20 [W] So we have to see exactly why it's been failing.
00:32:23 [W] So we'll click on that last job, but this job goes through and gathers up the metadata for see the endpoints. We still have to in points here if you were open
00:32:38 [W] And so I'll click on that last year but this job goes through and gathers up the metadata for see the endpoints. We still have two endpoints here issuer open ID key
00:32:52 [W] And issuer open ID configuration.
00:32:55 [W] I suspect those are in points.
00:32:57 [W] that will be beta and that will need to get back with them.
00:33:00 [W] But this is intended to be a release informing job for now and and long-term.
00:33:07 [W] I release blocking up so that Sig release would be aware that this new API the ones listed here should not be part of the release and we need to revert those promotions to ga.
00:33:20 [W] Thanks for those questions.
00:33:21 [W] Those are really good. We have a meeting every two weeks.
00:33:26 [W] Please join us on the kubernetes slack at Kate's - conformance or if you want to spend some time sharing and pairing with us.
00:33:34 [W] Just reach out to hippie hacker bobbing bumps on Slide.
00:33:44 [W] Some of the questions I will continue over on to Kook on maintainer will answer any more questions to thank you so much, beautiful.
